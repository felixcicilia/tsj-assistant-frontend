<!-- src/app/chat/chat.component.html -->
<div class="tsj-chat">
  <div class="tsj-chat-layout">
    <!-- ▓▓ Sidebar (historial) ▓▓ -->
    <aside class="tsj-sidebar">
      <header class="tsj-sidebar-header">
        <div>
          <p class="tsj-sidebar-kicker">Historial</p>
          <h2 class="tsj-sidebar-title">Sesiones</h2>
          <p class="tsj-sidebar-subtitle">Revise sus consultas previas o inicie una nueva.</p>
        </div>

        <button type="button" class="btn btn-sm tsj-sidebar-new" (click)="startNewSession()">
          <span class="me-1">+</span> Nueva sesión
        </button>
      </header>

      <div class="tsj-sidebar-list">
        <button
          *ngFor="let s of sessions; trackBy: trackBySessionId"
          type="button"
          class="tsj-session-item"
          [class.tsj-session-item--active]="selectedSession && selectedSession.id === s.id"
          (click)="selectSession(s)"
        >
          <span class="tsj-session-title text-truncate">
            {{ s.title || 'Consulta sin título' }}
          </span>
          <span class="tsj-session-meta">
            {{ s.createdAt | date : 'short' }}
          </span>
        </button>

        <div class="tsj-sidebar-empty" *ngIf="sessions.length === 0">
          <p class="mb-1 fw-semibold">Sin sesiones registradas</p>
          <p class="mb-0">
            Cree su primera consulta usando el botón
            <strong>“Nueva sesión”</strong>.
          </p>
        </div>
      </div>
    </aside>

    <!-- ▓▓ Panel principal ▓▓ -->
    <main class="tsj-main">
      <!-- Header -->
      <header class="tsj-main-header">
        <div>
          <h1 class="tsj-main-title">
            {{
              selectedSession
                ? selectedSession.title || 'Consulta en curso'
                : 'Asistente jurídico TSJ'
            }}
          </h1>
          <p class="tsj-main-subtitle" *ngIf="selectedSession">
            Canal: {{ selectedSession.channel }} • Creada:
            {{ selectedSession.createdAt | date : 'short' }}
          </p>
          <p class="tsj-main-subtitle" *ngIf="!selectedSession">
            Inicie una nueva consulta o seleccione una sesión del historial.
          </p>
        </div>
      </header>

      <!-- Mensajes -->
      <section class="tsj-main-messages">
        <!-- Estado vacío -->
        <div class="tsj-main-empty" *ngIf="!selectedSession">
          <div class="tsj-main-empty-inner">
            <h2 class="mb-2">Bienvenido al asistente jurídico</h2>
            <p class="mb-0">
              Use la caja de texto inferior para plantear su primera pregunta o seleccione una
              sesión previa en el panel izquierdo.
            </p>
          </div>
        </div>

        <!-- Mensajes de la sesión -->
        <div *ngIf="selectedSession">
          <div
            *ngFor="let msg of messages; trackBy: trackByMsgId"
            class="tsj-message"
            [ngClass]="{
              'tsj-message--user': isUser(msg),
              'tsj-message--assistant': isAssistant(msg)
            }"
          >
            <div class="tsj-message-bubble">
              <div class="tsj-message-header">
                <span class="tsj-message-author">
                  {{ msg.role === 'user' ? 'Usted' : 'Asistente TSJ' }}
                </span>
                <span class="tsj-message-time">
                  {{ msg.createdAt | date : 'shortTime' }}
                </span>
              </div>
              <div class="tsj-message-content">
                {{ msg.content }}
              </div>
            </div>
          </div>

          <p class="tsj-main-no-messages" *ngIf="messages.length === 0">
            Esta sesión aún no tiene mensajes registrados.
          </p>
        </div>
      </section>

      <!-- Entrada de texto -->
      <footer class="tsj-main-input">
        <form (ngSubmit)="sendMessage()">
          <label class="tsj-input-label"> Nueva consulta al asistente </label>
          <textarea
            class="form-control tsj-input-area"
            rows="3"
            [(ngModel)]="newQuestion"
            name="question"
            placeholder="Describa su consulta: fase procesal, tipo de audiencia, artículo o situación concreta…"
          ></textarea>

          <div class="tsj-input-actions">
            <small class="text-muted">
              Las respuestas son orientativas y no sustituyen el criterio jurídico del operador.
            </small>

            <button
              type="submit"
              class="btn tsj-submit-btn"
              [disabled]="!newQuestion?.trim() || sending"
            >
              <span class="spinner-border spinner-border-sm me-2" *ngIf="sending"></span>
              Enviar consulta
            </button>
          </div>
        </form>
      </footer>
    </main>
  </div>
</div>
