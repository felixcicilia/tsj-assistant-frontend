<!-- src/app/chat/chat.component.html -->
<div class="tsj-chat">
  <div class="tsj-chat-layout">
    <!-- ▓▓ Sidebar (historial) ▓▓ -->
    <aside class="tsj-sidebar">
      <header class="tsj-sidebar-header">
        <div class="tsj-sidebar-title-block">
          <span class="tsj-sidebar-kicker">HISTORIAL</span>
          <span class="tsj-sidebar-title">Sesiones</span>
        </div>

        <button
          type="button"
          class="tsj-sidebar-new"
          (click)="startNewSession()"
          [disabled]="sending"
        >
          <span class="me-1">+</span> Nueva sesión
        </button>
      </header>

      <div class="tsj-sidebar-list">
        <button
          *ngFor="let s of sessions; trackBy: trackBySessionId"
          type="button"
          class="tsj-sidebar-item"
          [class.tsj-sidebar-item--active]="selectedSession && selectedSession.id === s.id"
          (click)="selectSession(s)"
        >
          <span class="tsj-sidebar-item-title text-truncate">
            {{ s.title || 'Consulta sin título' }}
          </span>
          <span class="tsj-sidebar-item-meta">
            {{ s.createdAt | date : 'short' }}
          </span>
        </button>

        <div class="tsj-sidebar-empty" *ngIf="sessions.length === 0">
          <p class="mb-1 fw-semibold">Sin sesiones registradas</p>
          <p class="mb-0">
            Cree su primera consulta usando el botón
            <strong>“Nueva sesión”</strong>.
          </p>
        </div>
      </div>
    </aside>

    <!-- ▓▓ Panel principal ▓▓ -->
    <main class="tsj-main">
      <!-- Header -->
      <header class="tsj-main-header">
        <div>
          <h1 class="tsj-main-title">
            {{
              selectedSession
                ? selectedSession.title || 'Consulta en curso'
                : 'Asistente jurídico TSJ'
            }}
          </h1>

          <p class="tsj-main-subtitle" *ngIf="selectedSession">
            Canal: {{ selectedSession.channel || 'web' }} • Creada:
            {{ selectedSession.createdAt | date : 'short' }}
          </p>

          <p class="tsj-main-subtitle" *ngIf="!selectedSession">
            Inicie una nueva consulta o seleccione una sesión del historial.
          </p>
        </div>
      </header>

      <!-- Mensajes -->
      <section class="tsj-main-messages">
        <!-- Estado vacío (sin sesión seleccionada) -->
        <div class="tsj-main-empty" *ngIf="!selectedSession">
          <div class="tsj-main-empty-inner">
            <h2 class="tsj-empty-title">Bienvenido al asistente jurídico</h2>

            <p class="tsj-empty-text">
              Inicie una consulta usando la caja inferior o seleccione una sesión previa en el
              historial del panel izquierdo.
            </p>
          </div>
        </div>

        <!-- Mensajes de la sesión -->
        <div *ngIf="selectedSession" #messagesContainer class="tsj-main-messages-scroll">
          <div
            *ngFor="let msg of messages; trackBy: trackByMsgId"
            class="tsj-message"
            [ngClass]="{
              'tsj-message--user': isUser(msg),
              'tsj-message--assistant': isAssistant(msg)
            }"
          >
            <div class="tsj-message-bubble">
              <div class="tsj-message-header">
                <span class="tsj-message-author">
                  {{ msg.role === 'user' ? 'Usted' : 'Asistente TSJ' }}
                </span>
                <span class="tsj-message-time">
                  {{ msg.createdAt | date : 'shortTime' }}
                </span>
              </div>

              <div class="tsj-message-content">
                {{ msg.content }}
              </div>
            </div>
          </div>

          <p class="tsj-main-no-messages" *ngIf="messages.length === 0">
            Esta sesión aún no tiene mensajes registrados.
          </p>
        </div>
      </section>

      <!-- Entrada de texto -->
      <footer class="tsj-main-input">
        <form (ngSubmit)="sendMessage()">
          <label class="tsj-input-label"> Nueva consulta al asistente </label>

          <textarea
            class="form-control tsj-input-area"
            rows="3"
            [(ngModel)]="newQuestion"
            name="question"
            placeholder="Describa su consulta: fase procesal, tipo de audiencia, artículo o situación concreta…"
            [disabled]="sending"
            (input)="autoResizeTextArea($event)"
          ></textarea>

          <div class="tsj-input-actions">
            <small>
              Las respuestas son orientativas y no sustituyen el criterio jurídico del operador.
            </small>

            <button
              type="submit"
              class="btn tsj-submit-btn"
              [disabled]="!newQuestion?.trim() || sending"
            >
              <span class="spinner-border spinner-border-sm me-2" *ngIf="sending"></span>
              {{ sending ? 'Consultando…' : 'Enviar consulta' }}
            </button>
          </div>
        </form>
      </footer>
    </main>
  </div>
</div>
